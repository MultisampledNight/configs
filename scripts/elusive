#!/usr/bin/env nix-shell
#!nix-shell -p zsh qemu_kvm -i zsh
# vim: ft=zsh
set -eu

if (( $# != 1 )); then
  echo "takes 1 argument: the name of the elusive instance" 1>&2
  exit 1
fi

project_name="$1"

base_image=$(readlink -- "/nix/var/nix/gcroots/per-user/$USER/elusive-base")
overlay_image="$HOME/zukunftslosigkeit/state/elusive/$project_name/overlay.qcow2"

# set up the overlay image first, if not already done
# it's actually pretty much useless for now since the iso is fully live, i.e. doesn't remember
# but qemu really really wants the main disk to be rw-able, so I'm giving it exactly that
# all interesting accesses should be done via virtfs anyway
if [[ ! -f $overlay_image ]]; then
  echo "creating overlay at $overlay_image since it doesn't exist yet"
  mkdir -p $(dirname -- "$overlay_image")
  qemu-img create \
    -o backing_file=$base_image,backing_fmt=raw \
    -f qcow2 $overlay_image
fi

# everything's ready, launch
qemu-system-x86_64 \
  $overlay_image \
  -name "elusive-$project_name" \
  -machine q35 \
  -cpu host \
  -smp cpus=8,cores=4,threads=2 \
  -m size=8G \
  -accel kvm \
  -nic user,restrict=off,hostfwd=tcp::50022-:22 \
  -device virtio-vga-gl \
  -display gtk,full-screen=on,gl=on
