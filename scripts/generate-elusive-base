#! /usr/bin/env nix-shell
#! nix-shell -p bash nixos-generators -i bash
# vim: ft=bash
set -euo pipefail

image_target="$HOME/zukunftslosigkeit/state/elusive/elusive-base"

# actually generate the image
image_in_store=$(nixos-generate \
	--format iso \
	--configuration $HOME/zukunftslosigkeit/configs/nixos/elusive/configuration.nix \
  | tail --lines 1)

# replace the old image, both in the GC root and on the disk
mkdir -p $(dirname -- $image_target)
ln -sf "$image_in_store" "/nix/var/nix/gcroots/per-user/multisn8/elusive-base"
ln -sf "$image_in_store" "$image_target"
